<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bunny CareMap</title>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Tailwind for styling -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet">

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.27.0/dist/supabase.min.js"></script>

<style>
  body, html { margin:0; height:100%; font-family:'Inter',sans-serif; }
  #map { width:100%; height:100%; }
  .search-bar { position:absolute; top:10px; left:50%; transform:translateX(-50%); z-index:1000; width:300px; }
  .search-bar input { width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; }
  .leaflet-marker-icon.bunny-pin { background-color:#00CEC8; border-radius:50%; width:24px; height:24px; text-align:center; color:white; line-height:24px; font-weight:bold; }
</style>
</head>
<body>

<div class="search-bar">
  <input type="text" id="postalSearch" placeholder="Enter postal code & press Enter">
</div>

<div id="map"></div>

<script>
  // -------- Supabase Setup --------
  const SUPABASE_URL = 'https://nfhbaojmrrocvdrgftqu.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_ZWRhwo5ikuNYIH9EksEypQ_nXE6jrwj';
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // -------- Leaflet Map --------
  const map = L.map('map').setView([40.5, -77.5], 7);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'&copy; OpenStreetMap contributors'
  }).addTo(map);

  // -------- Markers --------
  let markers = {};

  function addMarker(c) {
    const icon = L.divIcon({className:'bunny-pin', html:'üê∞', iconSize:[24,24]});
    const marker = L.marker([c.latitude, c.longitude], {icon:icon}).addTo(map);
    const popupContent = `
      <div>
        <strong>Languages:</strong> ${c.languages || ''}<br>
        <strong>Experience:</strong> ${c.experience || ''}<br>
        <strong>Drives:</strong> ${c.drives?'Yes':'No'}<br>
        <strong>TB Test:</strong> ${c.tb_test?'Yes':'No'}<br>
        <strong>Gender:</strong> ${c.gender || ''}<br>
        <strong>Notes:</strong> ${c.notes || ''}
      </div>
    `;
    marker.bindPopup(popupContent);
    markers[c.id] = marker;
  }

  async function loadCaregivers() {
    const { data } = await supabase.from('caregivers').select('*');
    data.forEach(c => addMarker(c));
  }
  loadCaregivers();

  supabase.from('caregivers').on('*', payload => {
    if(payload.eventType==='INSERT' || payload.eventType==='UPDATE'){
      if(markers[payload.new.id]){
        markers[payload.new.id].setLatLng([payload.new.latitude,payload.new.longitude]);
      } else addMarker(payload.new);
    }
    if(payload.eventType==='DELETE'){
      if(markers[payload.old.id]){
        map.removeLayer(markers[payload.old.id]);
        delete markers[payload.old.id];
      }
    }
  }).subscribe();

  // -------- Click to add caregiver --------
  map.on('click', async e => {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;
    const languages = prompt("Languages (comma separated):");
    const experience = prompt("Experience:");
    const drives = confirm("Drives? OK=Yes, Cancel=No");
    const tb_test = confirm("TB Test done? OK=Yes, Cancel=No");
    const gender = prompt("Gender (Male/Female/Other):");
    const notes = prompt("Notes:");

    await supabase.from('caregivers').insert([{
      postal_code:'',
      latitude: lat,
      longitude: lng,
      languages,
      experience,
      drives,
      tb_test,
      gender,
      notes
    }]);
  });

  // -------- Postal code search --------
  document.getElementById('postalSearch').addEventListener('keypress', async e=>{
    if(e.key==='Enter'){
      const postal = e.target.value.trim();
      if(!postal) return;
      const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&country=US&postalcode=${postal}`);
      const geoData = await geoRes.json();
      if(!geoData.length){ alert('Invalid postal code'); return; }
      const lat = geoData[0].lat;
      const lng = geoData[0].lon;
      map.setView([lat, lng], 13);

      const languages = prompt("Languages (comma separated):");
      const experience = prompt("Experience:");
      const drives = confirm("Drives? OK=Yes, Cancel=No");
      const tb_test = confirm("TB Test done? OK=Yes, Cancel=No");
      const gender = prompt("Gender (Male/Female/Other):");
      const notes = prompt("Notes:");

      await supabase.from('caregivers').insert([{
        postal_code: postal,
        latitude: lat,
        longitude: lng,
        languages,
        experience,
        drives,
        tb_test,
        gender,
        notes
      }]);

      e.target.value='';
    }
  });

  // -------- Preload office pins --------
  const offices = [
    {name:"Greater Philadelphia ‚Äì Main Office", lat:40.142469, lng:-74.962295},
    {name:"Allentown ‚Äì Regional Office", lat:40.6026, lng:-75.4711},
    {name:"Lancaster ‚Äì Regional Office", lat:40.0379, lng:-76.3055}
  ];

  offices.forEach(o=>{
    const icon = L.divIcon({className:'bunny-pin', html:'üè¢', iconSize:[24,24]});
    L.marker([o.lat, o.lng], {icon:icon}).addTo(map)
      .bindPopup(`<strong>${o.name}</strong>`);
  });

</script>
</body>
</html>
